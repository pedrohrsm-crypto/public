<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Sincroniza√ß√£o Offline - ONGConnect</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 1rem; margin: 1rem 0; border-radius: 4px; font-weight: bold; }
        .status.online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        button { background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin: 0.5rem 0; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin: 1rem 0; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; }
        .log-entry { margin: 0.25rem 0; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teste de Sincroniza√ß√£o Offline</h1>
        <p>Esta p√°gina testa a funcionalidade de sincroniza√ß√£o offline do formul√°rio de cadastro de volunt√°rio.</p>
        
        <div id="connection-status" class="status online">üü¢ Online</div>
        
        <div>
            <h3>A√ß√µes de Teste</h3>
            <button onclick="testSubmission()">Enviar Teste (Simulado)</button>
            <button onclick="goOffline()">Simular Offline</button>
            <button onclick="goOnline()">Simular Online</button>
            <button onclick="checkPendingSubmissions()">Verificar Pend√™ncias</button>
            <button onclick="clearStorage()">Limpar Armazenamento</button>
            <button onclick="triggerSync()">For√ßar Sincroniza√ß√£o</button>
        </div>
        
        <div>
            <h3>Log de Eventos</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Limpar Log</button>
        </div>
        
        <div>
            <h3>Links de Navega√ß√£o</h3>
            <a href="pages/cadastro.html">Ir para Cadastro de Volunt√°rio</a> |
            <a href="pages/index.html">P√°gina Inicial</a>
        </div>
    </div>

    <script>
        let isOnline = navigator.onLine;
        let testSubmissionCount = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TestSync] ${message}`);
        }

        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connection-status');
            if (isOnline) {
                statusDiv.className = 'status online';
                statusDiv.textContent = 'üü¢ Online';
            } else {
                statusDiv.className = 'status offline';
                statusDiv.textContent = 'üî¥ Offline';
            }
        }

        async function testSubmission() {
            testSubmissionCount++;
            log(`Iniciando envio de teste #${testSubmissionCount}`, 'info');
            
            try {
                // Open IndexedDB and store a test submission
                const db = await openTestDB();
                const testData = {
                    formData: {
                        firstName: `Teste Usu√°rio ${testSubmissionCount}`,
                        email: `teste${testSubmissionCount}@exemplo.com`,
                        phone: '(11) 99999-9999',
                        birthDate: '1990-01-01',
                        agreeContact: 'on',
                        agreeData: 'on'
                    },
                    timestamp: Date.now(),
                    synced: false,
                    retryCount: 0
                };
                
                await storeTestSubmission(db, testData);
                log(`Dados salvos no IndexedDB (simulando offline)`, 'success');
                
                if (isOnline && 'serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.ready;
                    await registration.sync.register('volunteer-form-sync');
                    log('Background sync registrado', 'success');
                }
            } catch (error) {
                log(`Erro no teste: ${error.message}`, 'error');
            }
        }

        function goOffline() {
            isOnline = false;
            updateConnectionStatus();
            log('Modo offline simulado', 'info');
        }

        function goOnline() {
            isOnline = true;
            updateConnectionStatus();
            log('Modo online simulado', 'info');
            
            // Trigger sync when going online
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.sync.register('volunteer-form-sync');
                }).then(() => {
                    log('Background sync registrado ap√≥s voltar online', 'success');
                }).catch(error => {
                    log(`Erro ao registrar sync: ${error.message}`, 'error');
                });
            }
        }

        async function checkPendingSubmissions() {
            try {
                const db = await openTestDB();
                const unsynced = await getUnsyncedTestSubmissions(db);
                log(`Encontradas ${unsynced.length} submiss√µes pendentes`, 'info');
                
                unsynced.forEach((submission, index) => {
                    log(`  ${index + 1}. ${submission.formData.firstName} (${new Date(submission.timestamp).toLocaleString()})`, 'info');
                });
            } catch (error) {
                log(`Erro ao verificar pend√™ncias: ${error.message}`, 'error');
            }
        }

        async function clearStorage() {
            try {
                const db = await openTestDB();
                const transaction = db.transaction(['volunteerSubmissions'], 'readwrite');
                const store = transaction.objectStore('volunteerSubmissions');
                await store.clear();
                log('Armazenamento local limpo', 'success');
            } catch (error) {
                log(`Erro ao limpar storage: ${error.message}`, 'error');
            }
        }

        async function triggerSync() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    await registration.sync.register('volunteer-form-sync');
                    log('Sincroniza√ß√£o for√ßada disparada', 'success');
                } catch (error) {
                    log(`Erro ao for√ßar sync: ${error.message}`, 'error');
                }
            } else {
                log('Service Worker n√£o suportado', 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // IndexedDB helpers for testing
        function openTestDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ONGConnectOffline', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('volunteerSubmissions')) {
                        const store = db.createObjectStore('volunteerSubmissions', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('synced', 'synced', { unique: false });
                    }
                };
            });
        }

        function storeTestSubmission(db, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['volunteerSubmissions'], 'readwrite');
                const store = transaction.objectStore('volunteerSubmissions');
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getUnsyncedTestSubmissions(db) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['volunteerSubmissions'], 'readonly');
                const store = transaction.objectStore('volunteerSubmissions');
                const index = store.index('synced');
                const request = index.getAll(false);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Event listeners
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            log('Conex√£o restaurada', 'success');
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
            log('Conex√£o perdida', 'error');
        });

        // Initialize
        updateConnectionStatus();
        log('P√°gina de teste carregada', 'info');
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => {
                log('Service Worker registrado', 'success');
            }).catch(error => {
                log(`Erro ao registrar SW: ${error.message}`, 'error');
            });
        }
    </script>
</body>
</html>